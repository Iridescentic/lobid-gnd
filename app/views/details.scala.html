@* Copyright 2017 Fabian Steeg, hbz. Licensed under the GPLv2 *@

@(resource: models.AuthorityResource)

@import play.api.libs.json._

@image() = {
    <img src='@resource.getImage.image' style="max-height:500px;" class="center-block"/>
    <div class='text-center small'><br/>@Html(resource.getImage.label)</div>
}

@moreToggle(field: String, value: String) = {
    @if(value.contains(field+"-hide-by-default")) {
        <a id='@field-more' title='Mehr anzeigen' href='javascript:void(0)' 
                onclick='$("#@field-hide-by-default").show(); $("#@field-more").hide(); $("#@field-less").show();'>
            <span class="octicon octicon-diff-added" aria-hidden="true"></span>
        </a>
        <a id='@field-less' style='display: none;' title='Weniger anzeigen' href='javascript:void(0)' 
                onclick='$("#@field-hide-by-default").hide(); $("#@field-less").hide(); $("#@field-more").show();'>
            <span class="octicon octicon-diff-removed" aria-hidden="true"></span>
        </a>
    }
}

@graph() = {
  <script type="text/javascript" src='@controllers.routes.Assets.versioned("javascripts/vis.js")'></script>
  <link href='@controllers.routes.Assets.versioned("stylesheets/vis-network.min.css")' type="text/css" />
  <style type="text/css">
    #gnd-network {
      width: 100%;
      height: 300px;
      border: 1px solid lightgray;
    }
  </style>
  <div id="gnd-network"></div>
  <script type="text/javascript">
    function changeCursor(cursor) {
      var networkCanvas = document.getElementById("gnd-network").getElementsByTagName("canvas")[0]
      networkCanvas.style.cursor = cursor;
    }
    function validTarget(target) {
      return target && target.match(/^\d.*/)
    }
    var container = document.getElementById('gnd-network');
    var data = {
      nodes: new vis.DataSet(@Html(resource.gndRelationNodes())),
      edges: new vis.DataSet(@Html(resource.gndRelationEdges()))
    };
    var options = {
      interaction: { hover: true },
      layout: { randomSeed: 2 },
      physics: {
        barnesHut: { avoidOverlap: 1 },
        stabilization: { enabled: true }
      }
    };
    var network = new vis.Network(container, data, options);
    network.selectNodes(['@resource.getId'], false)
    network.on("stabilizationIterationsDone", function () {
      network.setOptions( { physics: false } );
      changeCursor('grab');
    });
    network.on("click", function (params) {
      var target = this.getNodeAt(params.pointer.DOM);
      if(validTarget(target)) {
        window.location.href = target;
      }
    });
    network.on("hoverNode", function (params) {
      var target = this.getNodeAt(params.pointer.DOM);
      if(validTarget(target)) {
        changeCursor('pointer');
      }
    });
    network.on('blurNode', function () {
      changeCursor('grab');
    });
  </script>
}

@main("", resource.preferredName) {
    <div class="page-header">
        <h1>@resource.title <small>
            <div class='pull-right'>
            <a title="JSON-LD-Indexdaten anzeigen" href='@routes.HomeController.authorityDotFormat(resource.getId, "json")'><img class='json-ld-icon' src='@routes.Assets.versioned("images/json-ld.png")'/></a>
            </div>
            </small>
        </h1>
    </div>
    <div class="row">
        <div class="col-md-@(if(resource.location == null && resource.getImage.image.isEmpty && resource.gndRelationEdges == "[]"){12}else{(if(resource.location != null && !resource.getImage.image.isEmpty){6}else{7})}) intro">
            <table class='table table-striped table-condensed'>
            @for(f <- resource.generalFields) {
                <tr><td>@models.GndOntology.label(f.getLeft)</td><td class='field-value'>@Html(f.getRight) @moreToggle(f.getLeft, f.getRight)</td></tr>
            }
            @for(f <- resource.additionalLinks) {
              <tr><td>@models.GndOntology.label(f.getLeft)</td><td class='field-value'>@Html(f.getRight) @moreToggle(f.getLeft, f.getRight)</td></tr>
            }
            </table>
            <div class="text-center small">
              Daten aus der <a title='RDF-XML aus GND anzeigen' href='https://d-nb.info/gnd/@resource.getId()/about/lds.rdf'>GND</a> 
              @if(resource.sameAs.size>3 || !resource.depiction.isEmpty){
                und <a title="JSON-LD in EntityFacts anzeigen" href='@(controllers.HomeController.config("entityfacts.live")+resource.getId)'>EntityFacts</a>
              } unter <a href='https://creativecommons.org/publicdomain/zero/1.0/'>CC0</a>
            </div>
        </div>
        @if(resource.location != null){
        <div class="col-md-@if(resource.location != null && !resource.depiction.isEmpty){3}else{5} intro">
            @if(resource.location != null) {
            <link rel="stylesheet" href='@controllers.routes.Assets.versioned("stylesheets/leaflet.css")' />
            <script src='@controllers.routes.Assets.versioned("javascripts/leaflet.js")'></script>
            <div id="authority-map" class="authority-map"></div>
            <script async type='text/javascript'>
              var layer = L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
              });
              var center = new L.LatLng(@resource.location.getLat, @resource.location.getLon)
              var map = new L.Map("authority-map", {
               center: center,
               zoom: @if(resource.getType.contains("Country")) {3} else {@if(resource.getType.contains("MemberState")) {5} else {10}},
               scrollWheelZoom: true,
               attributionControl: true,
               zoomControl: true
              });
              var marker = L.marker(center,{
                title: '@resource.title'
              });
              marker.addTo(map);
              map.addLayer(layer);
            </script>
            }
            @if(resource.location == null && !resource.getImage.image.isEmpty){
                @image()
            }
        </div>
        }
        @if(!resource.getImage.image.isEmpty){
             <div class="col-md-@if(resource.location != null){3}else{5} intro">
                 @image()
             </div>
        }
        @if(resource.gndRelationEdges != "[]") {
             <div class="col-md-@if(resource.location != null){3}else{5} intro">
                 @graph()
             </div>
        }
    </div>
}
